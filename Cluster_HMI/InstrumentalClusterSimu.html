<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Cluster</title>
<script src="jquery-3.4.1.min.js"></script>
</head>
<style>
	@keyframes slideIn {
	  0% {
	    transform: translateY(+100%);
			opacity: 0;
	  }
	  100% {
	    transform: translateY(0);
			opacity: 1;
	  }
	}
	#cluster{
		position:absolute;
		left:0%;
		top:0%;
	}

	#logo{
		animation: 1s ease-out 0s 1 slideIn;
		position: absolute;
		right: 0;
		top: 0;
		min-width: 100%;
	}

	.element{
		visibility:hidden;
		position:relative;
		top: -30px; 
		width:0px;
		height:0px;
		border:1px solid #000;
	}
	.inputVal{
		display:inline;
	}
	#buttonVal{
		display:inline;
	}
	#hideButton{
		background-color: #f1f1f1;
		color: black;
		border: 2px solid #000;
	}
	button{
		background-color: #f1f1f1;
		color: black;
		border: 2px solid #000;
	}
	input{
		background-color: #f1f1f1;
		color: black;
		border: 2px solid #000;
		width:50px;
	}
	#buttonVal{
		background-color:#f1f1f1;
		color: black;
		border: 2px solid #000;
		border-bottom:2px solid #000;
	}
	body {
	  overflow: hidden; 
	  background: #000;
	}
</style>

<body>
    <canvas id="cluster">
    	Instrumental Cluster Canvas.
    </canvas>
		
	<!-- TODO: NAMING CONVENTION NEEDS TO BE CONSISTENT -->
	<!-- Loading all image elements -->
	<!-- General -->
	    <img id="BG" 			class="element" src="bg.png"			/>
		<img id="over" 			class="element" src="over.png"			/>
		<img id="shadow" 		class="element" src="shadow.png"		/>
		<img id="bridge" 		class="element" src="bridge.png"		/>
		<img id="bridgeGlass" 	class="element" src="bridgeGlass.png"	/>
		<img id="amgLogo" 		class="element" src="amgLogo.png"		/>

	<!-- Gauges Common -->
	    <img id="speedRing" 		class="element" src="skorostomer/skorostomerRing.png"		/>
	    <img id="speedArrow" 		class="element" src="skorostomer/skorostomermidarrow.png"	/>
		<img id="speedMidError" 	class="element" src="skorostomer/skorostomermidError.png"	/>

	<!-- Speedometer -->
	    <img id="speedBG" 		class="element" src="skorostomer/skorostomerbg.png"		/>
	    <img id="speedNumKM" 	class="element" src="skorostomer/skorostomernum.png"	/>
  		<!-- TODO: UNUSED -->
	    <img id="speedNumMPH" 	class="element" src="skorostomer/skorostomernumMPH.png"	/>
	    <img id="speedMid" 		class="element" src="skorostomer/skorostomermid.png"	/>
		<img id="speedGlass" 	class="element" src="skorostomer/skorostomerEffect.png"	/>

    <!-- Tachometer -->
	    <img id="tachoBG" 			class="element" src="tachomer/tachometerbg.png"				/>
  		<!-- TODO: UNUSED -->
	    	<img id="tachoNumTDI" 		class="element" src="tachomer/tachometerNumTDI.png"			/>
	    <img id="tachoNumBen" 		class="element" src="tachomer/tachometerNum.png"			/>
	    <img id="tachoMid" 			class="element" src="tachomer/tachomid.png"					/>
	    <img id="speedGlassLeft" 	class="element" src="skorostomer/skorostomerEffectLeft.png"	/>
  
  	<!-- Gear -->
  		<!-- TODO: UNUSED -->
	    	<img id="gear" class="element" src="gear/gear.png" />
  		<!-- TODO: UNUSED -->
			<img id="gearGlass" class="element" src="gear/gearGlass.png" />
    
    <!-- Odometer -->
	    <img id="odometerKM" 		class="element" src="odometer/odometerKM.png" 		/>
  		<!-- TODO: UNUSED -->
	    <img id="odometerMPH" 		class="element" src="odometer/odometerMPH.png" 		/>
		<img id="odometerGlass" 	class="element" src="odometer/odometerGlass.png" 	/>
		<img id="odometerEffect" 	class="element" src="odometer/odometerEffect.png" 	/>
	 
	<!-- Inside and Outside Temperature -->
	    <img id="outsideTemp" 		class="element" src="outsideTemp/outsideTemp.png" 			/>
	    <img id="insideTemp" 		class="element" src="outsideTemp/insideTemp.png" 			/>
	    <img id="tempGlass" 		class="element" src="outsideTemp/tempEffect.png" 			/>
	    <img id="tempIcon" 			class="element" src="outsideTemp/outsideTempIcon.png" 		/>
	    <img id="tempIconError" 	class="element" src="outsideTemp/outsideTempIconError.png" 	/>
	    <img id="tempInIcon" 		class="element" src="outsideTemp/insideTempIcon.png" 		/>
	    <img id="tempInIconError" 	class="element" src="outsideTemp/insideTempIconError.png" 	/>
	    <img id="outsideTempError" 	class="element" src="outsideTemp/outsideTempError.png"	 	/>
	    
    <!-- Cooling Temperature -->
	    <img id="coolingTempBG" 			class="element" src="coolingTemp/coolingTempBG.png" 		/>
	    <img id="coolingTempBar" 			class="element" src="coolingTemp/coolingTempBar.png" 		/>
	    <img id="coolingTempIndic" 			class="element" src="coolingTemp/coolingTempIn.png"			/>
	    <img id="coolingTempIcon" 			class="element" src="coolingTemp/coolingTempIcon.png" 		/>
	    <img id="coolingTempIconError" 		class="element" src="coolingTemp/coolingTempIconError.png" 	/>
		<img id="coolingTempGlass" 			class="element" src="coolingTemp/coolingTempЕffect.png" 	/>
		<img id="coolingTempBGError" 		class="element" src="coolingTemp/coolingTempBGError.png" 	/>
		<img id="coolingTempIndicError" 	class="element" src="coolingTemp/coolingTempInError.png" 	/>
	    <img id="coolingCurr" 				class="element" src="coolingTemp/coolCurr.png" 				/>
	    <img id="coolingCurrCold" 			class="element" src="coolingTemp/coolCurrCold.png" 			/>
	    <img id="coolingCurrHot" 			class="element" src="coolingTemp/coolCurrHot.png" 			/>

	<!-- Fuel Bargraph -->
		<img id="fuelBG" 			class="element" src="fuel/fuelBG.png" 			/>
	    <img id="fuelBar" 			class="element" src="fuel/fuelBar.png" 			/>
	    <img id="fuelIn" 			class="element" src="fuel/fuelIn.png" 			/>
	    <img id="fuelInZero" 		class="element" src="fuel/fuelInZero.png" 		/>
	    <img id="fuelInFull" 		class="element" src="fuel/fuelInFull.png" 		/>
	    <img id="fuelBGError" 		class="element" src="fuel/fuelBGError.png" 		/>
	    <img id="fuelInError" 		class="element" src="fuel/fuelInError.png" 		/>
	    <img id="fuelIcon" 			class="element" src="fuel/fuelIcon.png" 		/>
	    <img id="fuelIconError" 	class="element" src="fuel/fuelIconError.png" 	/>
	    <img id="fuelCurr" 			class="element" src="fuel/fuelCurr.png" 		/>
	    <img id="fuelCurrZ" 		class="element" src="fuel/fuelCurrZ.png"		/>

	<!-- RTT's -->
	<!-- Left Blinker RTT -->
	    <img id="leftTurn" 			class="element" src="icons/arrowLeft.png" 				/>
	    <img id="leftTurnEmpty" 	class="element" src="icons/arrowLeftEmpty.png" 			/>
	    <img id="leftTurnInactive" 	class="element" src="icons/arrowLeftEmptyInactive.png" 	/>
	
	<!-- Right Blinker RTT -->
	    <img id="rightTurn" 			class="element" src="icons/arrowRight.png" 				/>
	    <img id="rightTurnEmpty" 		class="element" src="icons/arrowRightEmpty.png" 		/>
	    <img id="rightTurnInactive" 	class="element" src="icons/arrowRightEmptyInactive.png" />
    
    <!-- Oil Pressure RTT -->
	    <img id="oilPressure" 			class="element" src="icons/oilPressure.png" 		/>
	    <img id="oilPressureInactive" 	class="element" src="icons/oilPressureInactive.png" />    
	   
	<!-- Battery Charge RTT -->
	    <img id="batteryCharge" 			class="element" src="icons/batteryCharge.png" 			/>
	    <img id="batteryChargeInactive" 	class="element" src="icons/batteryChargeInactive.png" 	/>
	
	<!-- Hazard Lights RTT -->
	    <img id="hazardLights" 			class="element" src="icons/warningTriangle.png" 		/>
	    <img id="hazardLightsInactive" 	class="element" src="icons/warningTriangleInactive.png" />
    
    <!-- Handbrake RTT -->
	    <img id="brakeWarning" 			class="element" src="icons/brakeWarning.png" 			/>
	    <img id="brakeWarningInactive" 	class="element" src="icons/brakeWarningInactive.png" 	/>
    
    <!-- Airbag RTT -->
	    <img id="airbag" 			class="element" src="icons/airbag.png" 			/>
	    <img id="airbagInactive" 	class="element" src="icons/airbagInactive.png" 	/>
    
    <!-- Light Beams RTT -->
	    <img id="highBeams" 		class="element" src="icons/highBeams.png" 		/>
	    <img id="lowBeams" 			class="element" src="icons/lowBeams.png" 		/>
	    <img id="parkingLights" 	class="element" src="icons/parkingLights.png" 	/>
	    <img id="inactiveLights" 	class="element" src="icons/inactiveLights.png" 	/>
	    <img id="errorLight" 		class="element" src="icons/errorLight.png" 		/>
    
    <!-- Door Open RTT -->
	    <img id="openDoorInactive" 	class="element" src="icons/openDoorInactive.png" 	/>
	    <img id="openDoor1" 		class="element" src="icons/openDoor1.png" 			/>
	    <img id="openDoor2" 		class="element" src="icons/openDoor2.png" 			/>
	    <img id="openDoor3" 		class="element" src="icons/openDoor3.png" 			/>
	    <img id="openDoor4" 		class="element" src="icons/openDoor4.png" 			/>
	    <img id="openDoor5" 		class="element" src="icons/openDoor5.png" 			/>
	    <img id="openDoor6" 		class="element" src="icons/openDoor6.png" 			/>
	    <img id="openDoor7" 		class="element" src="icons/openDoor7.png" 			/>
	    <img id="openDoor8" 		class="element" src="icons/openDoor8.png" 			/>
	    <img id="openDoor9" 		class="element" src="icons/openDoor9.png" 			/>
	    <img id="openDoor10" 		class="element" src="icons/openDoor10.png" 			/>
	    <img id="openDoor11" 		class="element" src="icons/openDoor11.png" 			/>
 
</body>

<script type="text/javascript">

//variables:
	//Canvas variables 
	var canvas = document.getElementById("cluster");
	var ctx = canvas.getContext("2d");
	var wRatio = 0.95;
	var hRatio = 0.90;

	var smoothing = 100;
	var lastUpdate = new Date().getTime();
	var lastUpdateTacho = new Date().getTime();
	var lastUpdateTurnRight = new Date().getTime();
	var lastUpdateTurnLeft = new Date().getTime();
	var sleepConstTurn = 1.25;
	var fontFam = 'Verdana';
	var timeConst = 7.5; //miliseconds

	//blinkers
	var isBlinkTurnOn = 0;
	var isBlinkTurnLeft = 0;

	//speedConst
	var tempValue = 0;
	var tempSleepVal = 0;
	var curValue = 0;
	var sleepConst = 500;
	var unitKM = 1;
	var curUnitKM = 1;
	var failsafeSpeed = 0;
	var isValidSpeed = 0;

	//tachoConst
	var tempSleepValTach = 0;
	var tempValueTach = 0;
	var curValueTach = 0;
	var unitBen = 1;
	var curUnitBen = 1;
	var failsafeTacho = 0;
	var isValidTacho = 0;

	var speedArrow = document.createElement('img');
	var tachArrow = document.createElement('img');

	//odometerConst
	var totalOdo = 0;
	var curOdo = 123;
	var failsafeOdo = 0;
	var failOdo = 0;
	var failOdoTot = 0;
	//coolingTempConst
	var curCoolingTemp = 50;
	var failsafeCoolingTemp = 50;
	var coolingCoef = 0.3;

	//fuelConst
	var curFuel = 0;

	//temp
	var tempUnit = 'C';
	var tempUnitInside = 'F';
	var tempGrow = 1;
	var tempTemp = 0;
	var curTemp = 0;
	var unitTemp = 0;
	var curUnitTemp = 0;
	var unitTempIn = 0;
	var curUnitTempIn = 0;

	//sizeConst
	var odoW, odoH, odoFont;
	var gaigeW, gaigeFont;
	var gearW, gearH, gearFont, gearFontNum;
	var coolW, coolH;
	var tempW, tempH, tempFont;
	var w,h;

	//TODO: Fix variables order, too messy
	var hidePrompt = 0;
	var testPrompt = 1;
	var readPrompt = 0;
	var show = 1;
	var lastTest = 1;
	var lastUpdateTest = new Date().getTime();

	var readSpeed, readOdo, readOdoTotal, readOutsideTemp, readButton1, readSpeedValidation, readTachoValidation;
	var readTacho, readGear, readInsideTemp, readCoolingTemp, readButtonTacho, readButtonTemp;
	var readTime, readFuel, readLeftTurn = 1, readRightTurn = 1, readOil = 1, readBattery = 1, readBrake = 1, readAirbag = 1 , readHazard = 1, readLights = 0, readOpenDoor = 0;
	var recieved, read;
	var curStyle = 0;

	var lostConnection = 1;

	//TODO: UNUSED ?
	var flagKM = 0;
	var flagC = 0;
	var unitsKM = 0;
	var units0C = 0;
	var readOutsideTempFahr = 0;
	var readSpeedMPH = 0;
	var flag2C = 0;
	var units0C2 = 0;
	var readInsideTempFahr = 0;
	var readOdoMPH = 0;
	var readOdoTotalMPH = 0;

//end of variables

//test
//TODO: UNUSED
	var buttonPrompt = 0;
	var buttonTacho = 0;
	var buttonTemp = 0;
	function testButton(int){
		if(int > 3 && int < 0){int = 3;}
		buttonPrompt = int;
	}
	function testButtonTacho(int){
		buttonTacho = int;
		//alert(buttonPrompt);	
	}
	function testButtonTemp(int){
		buttonTemp = int;
		//alert(buttonPrompt);	
	}

//Init
canvas.width = window.innerWidth * wRatio;
canvas.height = window.innerHeight * hRatio;
speedArrow.src = "style1/skorostomer/skorostomermidarrow.png";
tachArrow.src = "style1/skorostomer/skorostomermidarrow.png";

function resize(){ w = canvas.width = innerWidth; h = canvas.height = canvas.width*0.50401;}
resize();
window.addEventListener("resize",resize);
window.addEventListener('load',function()
{
	calculateElements();
	drawCanvasBasics();
});

// main function
//TODO: Check UNUSED Content (MPH, etc)
function update(){
    var ihM,iwM, ihMTc, iwMTc;
	calculateElements();
    if(lostConnection == 1){
		WebSocketTest();
	}
	getInputs();

	ctx.setTransform(1,0,0,1,0,0);
    ctx.clearRect(0,0,w,h);
	drawBG();
    if(tachArrow.complete){
	  var iw = tachArrow.width;
      var ih = tachArrow.height;
	  var spr = spritesTacho[0];
	  var rot;
	  if(checkEngine() == 1){
		  rot = calcRotationBen(readTacho);
		  spr.r = rot *(Math.PI/180);
		  spr.xr = ((spr.x % iwMTc) + iwMTc) % iwMTc - iw * spr.scale;
		  spr.yr = ((spr.y % ihMTc) + ihMTc) % ihMTc - ih * spr.scale;
		  drawArrowTachoBen(tachArrow,spr);
	  }else{
		  rot = calcRotationTDI(readTacho);
		  spr.r = rot *(Math.PI/180);
		  spr.xr = ((spr.x % iwMTc) + iwMTc) % iwMTc - iw * spr.scale;
		  spr.yr = ((spr.y % ihMTc) + ihMTc) % ihMTc - ih * spr.scale;
		  drawArrowTachoTDI(tachArrow,spr);
	  }
	}
    if(speedArrow.complete){
      var iw = speedArrow.width;
      var ih = speedArrow.height;
	  var spr = sprites[0];
	  var rot;
	  if(unitsKM == 0){
		  rot = calcRotationKM(readSpeed);
		  spr.r = rot *(Math.PI/180);
		  spr.xr = ((spr.x % iwM) + iwM) % iwM - iw * spr.scale;
		  spr.yr = ((spr.y % ihM) + ihM) % ihM - ih * spr.scale;
		  drawArrowSpeedKM(speedArrow,spr);
		  checkOdo(readOdo, readOdoTotal);
		  displayOdometerKM(readOdo, readOdoTotal);
	  }else{
		  
	  }
    }  
	var cool = calcCoolingTemp(readCoolingTemp);
    var fuel = calcFuel(readFuel);
	displayCoolingTemp(cool);
	if(units0C == 1){
		tempUnit = 'F';
		displayOutsideTempFahr(readOutsideTempFahr);
	}else{
		tempUnit = 'C';
		displayOutsideTempCelsius(readOutsideTemp);
	}
    if(units0C2 == 1){
		tempUnitInside = 'F';
		displayInsideTempFahr(readInsideTempFahr);
	}else{
		tempUnitInside = 'C';
		displayInsideTempCelsius(readInsideTemp);
	}
    displayFuel(fuel);
    displayClock(readTime);
    displayIcons();
    displayGear(readGear);
	
	drawOver();
    requestAnimationFrame(update);
}


//WebSocket funcs
function WebSocketTest() 
{
	var testRec;
  	if ("WebSocket" in window) {
		var ws = new WebSocket("ws://localhost:8080");
		ws.onerror = function() {  }
		ws.onopen = function() 
			{ 
			  lostConnection = 0;
			};
		ws.onmessage = function (evt) 
			{ 
			 var received_msg = evt.data;
			 testRec = evt.data;
			 setRecieved(testRec);
			};
		ws.onclose = function() 
			{ 
			lostConnection = 1;
			};
	} else {}
}

function setRecieved(input)
{
	recieved = input; 
}

function getSubStr(str, delim) {
	var a = str.indexOf(delim);
	if (a == -1)
		return '';
	var b = str.indexOf(delim, a+1);
	if (b == -1)
		return '';
	testStr = str.substring(b + 1);
	return str.substr(a+1, b-a-1);
}

function calcVIP()
{
	//SPEEDOMETER_VALUE|SPEEDO_VALID|TACHOMETER_VALUE|TACHO_VALID|FUEL_LEVEL|ODO_RUN_VALUE|ODO_TOTAL_VALUE|
	//GEAR_VALUE|INNER_TEMP_VALUE|OUTER_TEMP_VALUE|COOLING_TEMP_VALUE|
	//LEFT_BLINKERS_VALUE|RIGHT_BLINKERS_VALUE|LIGHTS_VALUE|DOORS_VALUE|
	//AIRBAG_VALUE|HANDBRAKE_ERROR_VALUE|ENGINE_OIL_ERROR_VALUE|BATTERY_CHARGE_ERROR_VALUE|
	//GENERIC_ERROR|STYLE_VALUE|
	
	setString(recieved);
	var speed 			= getSubStr(testStr, '|'); //SPEEDOMETER_VALUE
	var speedValid 		= getSubStr(testStr, '|'); //SPEEDO_VALID
	var tacho 			= getSubStr(testStr, '|'); //TACHOMETER_VALUE
	var tachoValid 		= getSubStr(testStr, '|'); //TACHO_VALID
	var fuel 			= getSubStr(testStr, '|'); //FUEL_LEVEL
	var tripOdo 		= getSubStr(testStr, '|'); //ODO_RUN_VALUE
	var totalTripOdo 	= getSubStr(testStr, '|'); //ODO_TOTAL_VALUE
	var gear 			= getSubStr(testStr, '|'); //GEAR_VALUE
	var inTemp 			= getSubStr(testStr, '|'); //INNER_TEMP_VALUE
	var outTemp 		= getSubStr(testStr, '|'); //OUTER_TEMP_VALUE
	var coolTemp 		= getSubStr(testStr, '|'); //COOLING_TEMP_VALUE
	var leftBlink 		= getSubStr(testStr, '|'); //LEFT_BLINKERS_VALUE
	var rightBlink 		= getSubStr(testStr, '|'); //RIGHT_BLINKERS_VALUE
	var lights 			= getSubStr(testStr, '|'); //LIGHTS_VALUE
	var doors 			= getSubStr(testStr, '|'); //DOORS_VALUE
	var airbag 			= getSubStr(testStr, '|'); //AIRBAG_VALUE
	var handbrake 		= getSubStr(testStr, '|'); //HANDBRAKE_ERROR_VALUE
	var engineOil 		= getSubStr(testStr, '|'); //ENGINE_OIL_ERROR_VALUE
	var batteryCharge 	= getSubStr(testStr, '|'); //BATTERY_CHARGE_ERROR_VALUE
	var hazardLight 	= getSubStr(testStr, '|'); //GENERIC_ERROR
	var style 			= getSubStr(testStr, '|'); //STYLE_VALUE
	
	
	readSpeed 			= speed*1; 					//SPEEDOMETER_VALUE
	readSpeedValidation = speedValid * 1;			//SPEEDO_VALID
	readTacho 			= tacho*1; 					//TACHOMETER_VALUE
	readTachoValidation = tachoValid * 1; 			//TACHO_VALID
	readFuel 			= fuel*1; 					//FUEL_LEVEL
	readOdo 			= tripOdo*1; 				//ODO_RUN_VALUE
	readOdoTotal 		= totalTripOdo*1; 			//ODO_TOTAL_VALUE
	readGear 			= gear; 					//GEAR_VALUE
	readInsideTemp 		= inTemp*1; 				//INNER_TEMP_VALUE
	readOutsideTemp 	= outTemp*1; 				//OUTER_TEMP_VALUE
	readCoolingTemp 	= coolTemp*1; 				//COOLING_TEMP_VALUE
	readLeftTurn 		= leftBlink*1; 				//LEFT_BLINKERS_VALUE
	readRightTurn 		= rightBlink*1; 			//RIGHT_BLINKERS_VALUE
	readLights 			= lights*1; 				//LIGHTS_VALUE
	readOpenDoor 		= doors*1; 					//DOORS_VALUE
	readAirbag 			= airbag*1; 				//AIRBAG_VALUE
	readBrake 			= handbrake*1; 				//HANDBRAKE_ERROR_VALUE
	readOil 			= engineOil*1; 				//ENGINE_OIL_ERROR_VALUE
	readBattery 		= batteryCharge*1; 			//BATTERY_CHARGE_ERROR_VALUE
	readHazard 			= hazardLight*1; 			//GENERIC_ERROR
	if((style*1 != curStyle) && (style*1 != "0")) 
	{ styleChange();	}							//STYLE_VALUE		
}

function getInputs()
{
	calcVIP();
	if(!readSpeedValidation){failsafeSpeed = 0; isValidSpeed = 0; readSpeed = 'a';}
	if(!readTachoValidation){failsafeTacho = 0; isValidTacho = 0; readTacho = 'a';}
	if(!readTachoValidation){failsafeOdo = 0; readOdo = 'a';}
	if(!readTachoValidation){failsafeOdo = 0; readOdoTotal = 'a';}
	if(!readCoolingTemp){failsafeCoolingTemp = 50; isValidCool = 0; readCoolingTemp='a';}
}

//General Drawing funcs

function drawBG()
{
	var bg = document.getElementById("BG");
	ctx.drawImage(bg, 0, 0, w, h);
	var bridge = document.getElementById("bridge");
	ctx.drawImage(bridge, 0, 0, w, h);
	var amgLogo = document.getElementById("amgLogo");
	ctx.drawImage(amgLogo, canvas.width*0.5-gaigeW*0.55, canvas.height*0.695, gaigeW, gaigeW*0.25);	
	var shadow = document.getElementById("shadow");
	ctx.drawImage(shadow, 0, 0, w, h);
	 
}

function drawOver()
{
 	var bridgeGlass = document.getElementById("bridgeGlass");
    if(curStyle == 1)
    {
    	var over = document.getElementById("over");
        ctx.drawImage(over, 0, 0, w, h);  
    }	 
}


function drawCanvasBasics()
{
	var carImgDivs = document.getElementsByClassName('element');
	for(var i = 0; i < carImgDivs.length; i++)
	{
    	var replacedSrc = carImgDivs[i].getAttribute('src');
    	replacedSrc = 'style1/' + replacedSrc;
    	carImgDivs[i].setAttribute("src", replacedSrc);
	}
	curStyle = 1;
	requestAnimationFrame(update);

	drawBG();
	drawSpeedometer();
	drawTachometer();
}

function setString(input)
{
	testStr = String(input);
}

function calculateElements(){
	odoW = Math.round(0.1505*w);	
	odoH = Math.round(0.1821*h);
	odoFont = Math.round(0.0137*w);
	gaigeFont = Math.round(0.034*w);
	gaigeW = Math.round(0.3343*w);
	gearW = Math.round(0.1337*w);
	gearH = Math.round(0.1989*h);
	gearFont = Math.round(0.0187*w);
	gearFontNum = Math.round(0.0301*w);
	coolW = Math.round(0.2173*w);
	coolH = Math.round(0.0928*h);
	tempW = Math.round(0.1706*w);
	tempH = Math.round(0.0862*h);
	tempFont = Math.round(0.0127*w)
}

//speedometer
function filter(targetVal){
	tempValue = targetVal;
	var constSmooth = smoothing / timeConst;
	var filterVal = curValue + (targetVal - curValue) / constSmooth;
	curValue = filterVal;
	return filterVal;
}
function drawSpeedometer(){
	var bg = document.getElementById("speedBG");
	var num = document.getElementById("speedNum");
	var mid = document.getElementById("speedMid");
	ctx.drawImage(bg, canvas.width*0.20, canvas.height*0.10, gaigeW, gaigeW);
	ctx.drawImage(num, canvas.width*0.20, canvas.height*0.10, gaigeW, gaigeW);
	ctx.drawImage(mid, canvas.width*0.20, canvas.height*0.10, gaigeW, gaigeW);
}
function DO(count,callback){ 
	while (count--) {
		callback(count); 
	}
}
const sprites = [];
DO(1,()=>{
    sprites.push({
       x : rand(w), y : rand(h),
       xr : 0, yr : 0, // actual position of sprite
       r : (Math.PI * 2),
       scale : 1,
       dr : 0.1,
    });
});
function displaySpeed(degree){
    var unit = "km/h";
    var posY; 
    var color;
    if(curStyle == 1){
    	color = '#000';
    	posY = canvas.height*0.10 +gaigeW*0.52;
    }
	else if(curStyle == 2){
		color = '#FFF';
		posY = canvas.height*0.10 +gaigeW*0.51;
	}
	ctx.fillStyle = color;
	if(degree == "--"){	ctx.fillStyle = '#FFF'; unit = "--"}
	ctx.textAlign = 'center'; 
	ctx.font = "italic " + gaigeFont.toString()+"px "+fontFam;
	ctx.fillText(degree,canvas.width*0.05 + gaigeW/2.05, posY);
	ctx.font = "italic " +(gearFontNum*0.4).toString()+"px "+fontFam;
	ctx.fillText(unit,canvas.width*0.05 + gaigeW/2.05, posY + gaigeW*0.05);
    
}
function drawArrowSpeedKM(image, spr){
	var bg = document.getElementById("speedBG");
	var num = document.getElementById("speedNumKM");
	var mid = document.getElementById("speedMid");
	var ring = document.getElementById("speedRing");
	var glass = document.getElementById("speedGlassLeft");
    var posX = canvas.width*0.05;
    var posY = canvas.height*0.10;
	ctx.drawImage(bg, posX, posY, gaigeW, gaigeW);

	ctx.save();
	ctx.setTransform(spr.scale, 0, 1, 0, spr.xr, spr.yr);
	ctx.translate(posX+ gaigeW/2 , posY+gaigeW*0.496);
	ctx.rotate(spr.r);
	ctx.drawImage(image, -gaigeW*0.065 / 2, 0, gaigeW*0.065, gaigeW*0.45);
	ctx.restore();

	ctx.drawImage(num, posX, posY, gaigeW, gaigeW);

	if(isValidSpeed == 0){
		mid = document.getElementById("speedMidError");
		ctx.drawImage(mid, posX, posY, gaigeW, gaigeW);
		displaySpeed("--");
	}else{
		if(elapsedTime()==1){
			ctx.drawImage(mid, posX, posY, gaigeW, gaigeW);
			tempSleepVal = tempValue;
			displaySpeed(tempValue);
		}else{
			ctx.drawImage(mid, posX, posY, gaigeW, gaigeW);
			displaySpeed(tempSleepVal);
		}
	}
	ctx.drawImage(glass, canvas.width*0.05, canvas.height*0.10, gaigeW, gaigeW);
}


function calcRotationKM(input){
	  if(isNaN(input)){
		  input = failsafeSpeed;
		  isValidSpeed = 0;
	  }else{isValidSpeed = 1;}
	  if(input > 260) {input = 0; isValidSpeed = 0;}
	  if(input < 0){input = 0; isValidSpeed = 0;}
	  var temp = filter(input);
	  var rotation;
	  if(temp >= 0 && temp < 50){
		  rotation =(temp/0.8425) + 25; 
	  }else if(temp >= 50 && temp < 100){
		  rotation = (temp/0.8325) + 25; 
	  }else if(temp >= 100 && temp < 140){
		  rotation = (temp/0.8425) + 25; 
	  }else if(temp >= 140 && temp < 170){
		  rotation = (temp/0.8425) + 25; 
	  }else if(temp >= 170 && temp < 220){
		  rotation = (temp/0.84) + 25; 
	  }else if(temp >= 220 && temp < 260){
		  rotation = (temp/0.8455) + 25; 
	  }
	  else if(temp == 260){
		  rotation = 332;  
	  }
	  return rotation;
}
function calcRotationMPH(input){
	  if(isNaN(input)){
		  input = failsafeSpeed;
		  isValidSpeed = 0;
	  }else{isValidSpeed = 1;}
	  if(input > 160) {input = 0; isValidSpeed = 0;}
	  if(input < 0) {input = 0; isValidSpeed = 0;}
	  var temp = filter(input);
	  var rotation;
	  if(temp < 100){
	  	rotation = (temp*1.9725) + 24;
	  }else if(temp >= 100 && temp < 140){
		 rotation = (temp*1.9375) + 24;
	  }else if(temp >=140 && temp < 160){
	  	 rotation = (temp*1.9275) + 24;	
	  }else if(temp >= 160){
		 rotation = (temp*1.9275) + 24;  
	  }
	  return rotation;
}

//tachometer
const spritesTacho = [];
DO(1,()=>{
    spritesTacho.push({
       x : rand(w), y : rand(h),
       xr : 0, yr : 0, // actual position of sprite
       r : (Math.PI * 2),
       scale : 1,
       dr : 0.1,
    });
});
function filterTacho(targetVal){
	tempValueTach = targetVal;
	var constSmooth = smoothing / timeConst;
	var filterVal = curValueTach + (targetVal - curValueTach) / constSmooth;
	curValueTach = filterVal;
	return filterVal;
}
function drawTachometer(){
	var bg = document.getElementById("tachoBG");
	var num = document.getElementById("tachoNumTDI");
	var mid = document.getElementById("tachoMid");
	ctx.drawImage(bg, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
	ctx.drawImage(num, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
	ctx.drawImage(mid, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
}
function drawArrowTachoBen(image, spr){
	var bg = document.getElementById("tachoBG");
	var num = document.getElementById("tachoNumBen");
	var mid = document.getElementById("tachoMid");
	var ring = document.getElementById("speedRing");
	var glass = document.getElementById("speedGlass");
	ctx.drawImage(bg, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
	ctx.save();
	ctx.setTransform(spr.scale, 0, 1, 0, spr.xr, spr.yr);
	ctx.translate(canvas.width*0.60+ gaigeW*0.5 , canvas.height*0.10+gaigeW*0.496);
	ctx.rotate(spr.r);
	ctx.drawImage(image, -gaigeW*0.065 / 2, 0, gaigeW*0.065, gaigeW*0.45);
	ctx.restore();
	ctx.drawImage(num, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
    
    if(isValidTacho == 0){
		mid = document.getElementById("speedMidError");
		ctx.drawImage(mid, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
		//displayTacho("--");
	}else{
		if(elapsedTimeTacho()==1){
			ctx.drawImage(mid, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
			tempSleepValTach = actTach;
			//displayTacho(actTach);
		}else{
			ctx.drawImage(mid, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
			//displayTacho(tempSleepValTach);
		}
	}
    
	//ctx.drawImage(ring, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
	//ctx.drawImage(glass, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
    
}
function drawArrowTachoTDI(image, spr){
	var bg = document.getElementById("tachoBG");
	var num = document.getElementById("tachoNumTDI");
	var mid = document.getElementById("tachoMid");
	var ring = document.getElementById("speedRing");
	var glass = document.getElementById("speedGlass");
	ctx.drawImage(bg, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
	ctx.save();
	ctx.setTransform(spr.scale, 0, 1, 0, spr.xr, spr.yr);
	ctx.translate(canvas.width*0.60+ gaigeW*0.5 , canvas.height*0.10+gaigeW*0.496);
	ctx.rotate(spr.r);
	ctx.drawImage(image, -gaigeW*0.065 / 2, 0, gaigeW*0.065, gaigeW*0.45);
	ctx.restore();
	ctx.drawImage(num, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
	
	if(isValidTacho == 0){
		mid = document.getElementById("speedMidError");
		ctx.drawImage(mid, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
		//displayTacho("--");
	}else{
		if(elapsedTimeTacho()==1){
			ctx.drawImage(mid, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
			tempSleepValTach = actTach;
			//displayTacho(actTach);
		}else{
			ctx.drawImage(mid, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
			//displayTacho(tempSleepValTach);
		}
	}
	ctx.drawImage(ring, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
	ctx.drawImage(glass, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
}
function displayTacho(degree){
	ctx.fillStyle = '#000';
	if(degree == "--"){	ctx.fillStyle = '#FFF';}
	ctx.textAlign = 'center';
	ctx.font = gaigeFont.toString()+"px "+fontFam;
	ctx.fillText(degree,canvas.width*0.60 + gaigeW*0.49, canvas.height*0.10 +gaigeW*0.53);
}
function calcRotationBen(input){
	  if(isNaN(input)){
		  input = failsafeTacho;
		  isValidTacho = 0;
	  }else{isValidTacho = 1;}
	  if(input > 7500) {input = 0; isValidTacho = 0;}
	  if(input < 0) {input = 0; isValidTacho = 0;}
	  actTach = input;
	  input = input / 100;
	  var temp = filterTacho(input);
	  var rotation;
	  if(temp >= 0 && temp <= 10){
		  rotation =(temp*3.943) + 36; 
	  }else if(temp > 10 && temp <= 20){
		  rotation =(temp*3.873) + 34;  
	  }else if(temp > 20 && temp < 30){
		  rotation =(temp*3.893) + 34;  
	  }else if(temp >= 30 && temp < 39){
		  rotation =(temp*3.923) + 34;  
	  }else if(temp >= 39 && temp < 50){
		  rotation =(temp*3.853) + 34;  
	  }else if(temp >= 50 && temp < 60){
		  rotation =(temp*3.823) + 34;  
	  }else if(temp >= 60 && temp < 75){
		  rotation =(temp*3.813) + 34;  
	  }else if(temp >= 75){
		  rotation =(temp*3.873) + 34;  
	  }
	  return rotation;
}
function calcRotationTDI(input){
	  if(isNaN(input)){
		  input = failsafeTacho;
		  isValidTacho = 0;
	  }else{isValidTacho = 1;}
	  if(input > 6000) {input = 0; isValidTacho = 0;}
	  if(input < 0) {input = 0; isValidTacho = 0;}
	  actTach = input;
	  input = input / 100;
	  var temp = filterTacho(input);
	  var rotation;
	  if(temp >= 0 && temp <= 10){
		  rotation =(temp*4.7617) + 34; 
	  }else if(temp > 10 && temp <= 20){
		  rotation =(temp*4.7617) + 34;  
	  }else if(temp >= 20 && temp < 30){
		  rotation =(temp*4.8317) + 34;  
	  }else if(temp >= 30 && temp <= 40){
		  rotation =(temp*4.7817) + 34;  
	  }else if(temp > 40 && temp < 50){
		  rotation =(temp*4.7617) + 34;  
	  }else if(temp >= 50 && temp < 60){
		  rotation =(temp*4.7217) + 34;  
	  }else if(temp >= 60){
		  rotation =(temp*4.7217) + 34;  
	  }
	  return rotation;
}
function checkEngine(){
	if(readButtonTacho == 1){
		changeUnitTacho();
		readButtonTacho = 0;
		buttonTacho = 0;
	}
	if(unitBen == curUnitBen){
		if(unitBen == 0){
			return 0;
		}else if(unitBen == 1){
			return 1;
		}
		
	}else{
		if(unitBen == 0){
			curUnitBen=0;
			return 0;	
		}else if(unitBen == 1){
			curUnitBen = 1;	
			return 1;
		}
	}
}
function changeUnitTacho(){
	if(unitBen == 0){
		unitBen = 1;
	}else if(unitBen == 1){
		unitBen = 0;	
	}
}
//odometer
function displayOdometerKM(curOdo, totalOdo){
	if(failOdo == 1){
		 curOdo = "--";
	}
	if(failOdoTot == 1){
		totalOdo = "----";
	}
	var bg = document.getElementById("odometerKM");
	ctx.drawImage(bg, canvas.width*0.395, canvas.height*0.2375, odoW, odoH);
	displayOdoSpeed(curOdo, totalOdo);
}
function displayOdometerMPH(curOdo, totalOdo){
	if(failOdo == 1){
		 curOdo = "--";
	}
	if(failOdoTot == 1){
		totalOdo = "--";
	}
	var bg = document.getElementById("odometerMPH");
	ctx.drawImage(bg, canvas.width*0.395, canvas.height*0.2375, odoW, odoH);
	displayOdoSpeed(curOdo, totalOdo);
}
function displayOdoSpeed(run, total){
	var glass = document.getElementById("odometerGlass");
	var effect = document.getElementById("odometerEffect");
	ctx.fillStyle = '#FFF';
	ctx.textAlign = 'right';
    ctx.font = odoFont.toString()+"px "+fontFam;
	ctx.fillText(run,canvas.width*0.395 + odoW*0.62, canvas.height*0.2375 + odoH/2 - odoH/7.5);	
	ctx.fillText(total,canvas.width*0.395 + odoW*0.62, canvas.height*0.2375 + odoH/2 + odoH/6);	
	ctx.drawImage(glass, canvas.width*0.395, canvas.height*0.2375, odoW, odoH);
	if(curStyle == 1){
		ctx.drawImage(effect, canvas.width*0.395, canvas.height*0.2375, odoW, odoH);
	}
}

function checkOdo(run, total){
	failOdo = 0;
	failOdoTot = 0;
	curOdo = run;
	totalOdo = total;
	if(!curOdo){curOdo = failsafeOdo; failOdo = 1;}
	if(!totalOdo){totalOdo = failsafeOdo; failOdoTot = 1;}
	if(isNaN(curOdo)){curOdo = failsafeOdo; failOdo = 1;}
	if(isNaN(totalOdo)){totalOdo = failsafeOdo; failOdoTot = 1;}
	if(totalOdo > 999999){totalOdo=999999;failOdoTot = 1;}
	if(curOdo > 999999){curOdo=999999;failOdo = 1;}
	if(totalOdo < 0) {totalOdo = 0;failOdoTot = 1;}
	if(curOdo < 0){curOdo = 0;failOdo = 1;}
	readOdo = curOdo;
	readOdoMPH = curOdo;
	readOdoTotal = totalOdo;
	readOdoTotalMPH = totalOdo;
}
//outsideTemp
function displayOutsideTempCelsius(input){
	var bg = document.getElementById("outsideTemp");
	var glass = document.getElementById("tempGlass");
    var icon = document.getElementById("tempIcon");
	var color = '#FFF';
	ctx.fillStyle = color; 
	curTemp = input;
	if(isNaN(input)){
		var temp = '--';
		ctx.fillStyle = color;
		ctx.textAlign = 'right'; 
    	ctx.font = (tempFont*1.2).toString()+"px "+fontFam;
     	icon = document.getElementById("tempIconError");
     	if(curStyle == 2){
        	bg = document.getElementById("outsideTempError");
        }
		ctx.drawImage(bg, canvas.width*0.38, canvas.height*0.4075, tempW, tempH);
        ctx.fillText(temp ,canvas.width*0.38 + 0.5*tempW, canvas.height*0.4075 + 0.6323*tempH, 1.0784*tempW, 1.0769*tempH);
	}else{
		var flag = 1;
		if(input > 85){
			input = 85;
			flag = 0;
		}
		if(input < -40){
			input = -40;
			flag = 0;			
		}
		input = (Math.round(input * 2) / 2).toFixed(1);

		tempTemp = input;
		ctx.textAlign = 'right'; 
		ctx.font = tempFont.toString()+"px "+fontFam;
		var display = input.toString() + "°" + tempUnit;
		if(flag == 0){
			display = "--";
			color = "#FFF"
			ctx.font = (tempFont*1.2).toString()+"px "+fontFam;
            icon = document.getElementById("tempIconError");
            if(curStyle == 2){
        		bg = document.getElementById("outsideTempError");
        	}
		}
		ctx.drawImage(bg, canvas.width*0.38, canvas.height*0.4075, tempW, tempH);
		if(curStyle == 2){
			if(input < -10 ){
				color = "#91b1ff";
			}else if(input >= -10 && input < 10){
	 			color = "#c1d3ff";
	 		}else if((input >= 10 && input <= 25)||(flag == 0)){
	 			color = "#FFF";
	 		}else if(input > 25 && input <= 35){
	 			color = "#ff8c8c";
	 		}else if(input > 35){
	 			color = "#ff3131";
	 		}
	 		ctx.fillStyle = color;
			ctx.textAlign = 'right'; 
		    ctx.font = "bold italic "+(tempFont*1).toString()+"px "+fontFam;
		    ctx.shadowColor="black";
			ctx.lineWidth=gearH*0.02;
			ctx.strokeText(display ,canvas.width*0.38 + 0.5*tempW, canvas.height*0.4075 + 0.6323*tempH, 1.0784*tempW, 1.0769*tempH);
		}
		ctx.fillText(display ,canvas.width*0.38 + 0.5*tempW, canvas.height*0.4075 + 0.6323*tempH, 1.0784*tempW, 1.0769*tempH);
	}
	ctx.drawImage(glass, canvas.width*0.38, canvas.height*0.4075, tempW, tempH);
	ctx.drawImage(icon, canvas.width*0.38, canvas.height*0.4075, tempW, tempH);
}
function displayOutsideTempFahr(input){
	var bg = document.getElementById("outsideTemp");
	var glass = document.getElementById("tempGlass");
	ctx.drawImage(bg, canvas.width*0.205, canvas.height*0.76, tempW, tempH);
	var color = '#FFF';
	curTemp = input;
	if(isNaN(input)){
		var temp = '--';
		ctx.fillStyle = color;
		ctx.textAlign = 'center'; 
    	ctx.font = odoFont.toString()+"px "+fontFam;
		ctx.fillText(temp ,canvas.width*0.2 + 1.3784*tempW, canvas.height*0.76 + tempH*0.8, 1.0784*tempW, 1.0769*tempH);	
	}else{
		var flag = 1;
		if(input > 185){
			input = 85;
			flag = 0;
		}
		if(input < -40){
			input = -40;
			flag = 0;
		}
		input = Math.round(input);
		if(input - tempTemp > 0){
			tempGrow = 1;
		}else if(input - tempTemp < 0){
			tempGrow = 0;	
		}
		if(input >= 41){
			color = '#D51B1E';	
		}else if(input <= 37){
			color = '#7896DB';	
		}else if(input > 37 && tempGrow == 1){
			color = '#7896DB';	
		}else if(input < 41 && tempGrow == 0){
			color = '#D51B1E';
		}
		tempTemp = input;
		ctx.textAlign = 'right'; 
		ctx.font = tempFont.toString()+"px "+fontFam;
		var display = input.toString() + "°" + tempUnit;
		if(flag == 0){
			display = "--";
			color = "#FFF"
			ctx.font = odoFont.toString()+"px "+fontFam;
		}
		ctx.fillStyle = color;
		ctx.fillText(display ,canvas.width*0.2 + 0.9516*tempW, canvas.height*0.76 + 0.6923*tempH, 1.0784*tempW, 1.0769*tempH);
	}
	ctx.drawImage(glass, canvas.width*0.205, canvas.height*0.76, tempW, tempH);
}
function displayInsideTempCelsius(input){
	var bg = document.getElementById("outsideTemp");
	var glass = document.getElementById("tempGlass");
    var icon = document.getElementById("tempInIcon");
	var color = '#FFF';
    ctx.textAlign = 'right';
    ctx.fillStyle = color;      
	curTempIn = input;
	if(isNaN(input)){
		var temp = '--';
    	ctx.font = (tempFont*1.2).toString()+"px "+fontFam;
     	icon = document.getElementById("tempInIconError");
		if(curStyle == 2){
        	bg = document.getElementById("outsideTempError");
        }
		ctx.drawImage(bg, canvas.width*0.38, canvas.height*0.485, tempW, tempH);
		ctx.fillText(temp ,canvas.width*0.38 + 0.5*tempW, canvas.height*0.485 + 0.6423*tempH, 1.0784*tempW, 1.0769*tempH);
	}else{
		var flag = 1;
		if(input > 85){
			input = 85;
			flag = 0;
		}
		if(input < -40){
			input = -40;
			flag = 0;
		}
		input = (Math.round(input * 2) / 2).toFixed(1);
		
		ctx.font = tempFont.toString()+"px "+fontFam;
		var display = input.toString() + "°" + tempUnitInside;
		if(flag == 0){
			display = "--";
			ctx.font = (tempFont*1.2).toString()+"px "+fontFam;
            icon = document.getElementById("tempInIconError");
            if(curStyle == 2){
            	bg = document.getElementById("outsideTempError");
            }
		}
		ctx.drawImage(bg, canvas.width*0.38, canvas.height*0.485, tempW, tempH);
		if(curStyle == 2){
			if(input < 10 ){
				color = "#91b1ff";
			}else if(input >= 10 && input < 18){
	 			color = "#c1d3ff";
	 		}else if((input >= 18 && input <= 23)||(flag == 0)){
	 			color = "#FFF";
	 		}else if(input > 23 && input <= 27){
	 			color = "#ff8c8c";
	 		}else if(input > 27){
	 			color = "#ff3131";
	 		}
	 		ctx.fillStyle = color;
			ctx.textAlign = 'right'; 
		    ctx.font = "bold italic "+(tempFont*1).toString()+"px "+fontFam;
		    ctx.shadowColor="black";
			ctx.lineWidth=gearH*0.02;
			ctx.strokeText(display ,canvas.width*0.38 + 0.5*tempW, canvas.height*0.485 + 0.6423*tempH, 1.0784*tempW, 1.0769*tempH);
		}
		ctx.fillText(display ,canvas.width*0.38 + 0.5*tempW, canvas.height*0.485 + 0.6423*tempH, 1.0784*tempW, 1.0769*tempH);
	}
	ctx.drawImage(glass, canvas.width*0.38, canvas.height*0.485, tempW, tempH);
	ctx.drawImage(icon, canvas.width*0.38, canvas.height*0.485, tempW, tempH);
}
function displayInsideTempFahr(input){
	var bg = document.getElementById("insideTemp");
	ctx.drawImage(bg, canvas.width*0.62, canvas.height*0.76, tempW, tempH);
	var glass = document.getElementById("tempGlass");
	var color = '#FFF';
	curTempIn = input;
	if(isNaN(input)){
		var temp = '--';
		ctx.fillStyle = color;
		ctx.textAlign = 'center'; 
    	ctx.font = odoFont.toString()+"px "+fontFam;
		ctx.fillText(temp ,canvas.width*0.62 + 1.3784*tempW, canvas.height*0.76 + tempH*0.8, 1.0784*tempW, 1.0769*tempH);
	}else{
		var flag = 1;
		if(input > 185){
			input = 85;
			flag = 0;
		}
		if(input < -40){
			input = -40;
			flag = 0;
		}
		input = Math.round(input);
		ctx.fillStyle = color;
		ctx.textAlign = 'right'; 
		ctx.font = tempFont.toString()+"px "+fontFam;
		var display = input.toString() + "°" + tempUnitInside;
		if(flag == 0){
			display = "--";
			ctx.font = odoFont.toString()+"px "+fontFam;
		}
		ctx.fillText(display ,canvas.width*0.62 + 0.9216*tempW, canvas.height*0.76 + 0.6423*tempH, 1.0784*tempW, 1.0769*tempH);
	}
	ctx.drawImage(glass, canvas.width*0.62, canvas.height*0.76, tempW, tempH);
}
//coolingTemp
function filterTemp(targetVal){
	var constSmooth = smoothing / timeConst;
	var filterVal = curCoolingTemp + (targetVal - curCoolingTemp) / constSmooth;
	curCoolingTemp = filterVal;
	return filterVal;
}
function calcCoolingTemp(input){
	if(isNaN(input)){
		input=failsafeCoolingTemp;	
		isValidCool = 0;
	}else{isValidCool = 1;}
	if(input > 130){input = 50; isValidCool = 0;}
	if(input < 50){input = 50; isValidCool = 0;}
	var temp = filterTemp(input);
	return temp;
}
var isValidCool = 0;
function displayCoolingTemp(barT){
	var bg = document.getElementById("coolingTempBG");
	var bar = document.getElementById("coolingTempBar");
	var indic = document.getElementById("coolingTempIndic");
    var icon = document.getElementById("coolingTempIcon");
	var glass = document.getElementById("coolingTempGlass");
	var curr = document.getElementById("coolingCurr");
   // var glassOver = document.getElementById("speedGlass");
	var coef = 0;
	var barW = Math.round(coolW*0.7385);
	//var bonCoef = Math.round(barW*0.025‬);
	if(isValidCool == 0){
		bar = document.getElementById("coolingTempBGError");
		indic = document.getElementById("coolingTempIndicError");
        icon = document.getElementById("coolingTempIconError");
	}
	ctx.drawImage(bg, canvas.width*0.29 + 0.15*gaigeW, canvas.height*0.56, coolW, coolH);
	ctx.drawImage(bar, canvas.width*0.29 + 0.15*gaigeW, canvas.height*0.56, coolW, coolH);
	var bonCoef = Math.round(0.085*coolH);
	coef = (barT/130)*barW+bonCoef;
	ctx.fillStyle = "rgba(255, 255, 255, 0)";
	ctx.fillRect(canvas.width*0.29 + 0.15*gaigeW+0.1231*coolW, canvas.height*0.56+0.0369*coolW,coef,0.6714*coolH);
	ctx.fillStyle = "rgba(0, 0, 0, 1)";
	ctx.fillRect(canvas.width*0.29 + 0.15*gaigeW+0.0369*coolW+coef,canvas.height*0.56+0.0369*coolW,barW+bonCoef-coef,0.6714*coolH);
	ctx.drawImage(indic, canvas.width*0.29 + 0.15*gaigeW, canvas.height*0.56, coolW, coolH);
	if(barT > 120){
		icon = document.getElementById("coolingTempIconError");
	}
 	if(curStyle == 2){
 		var color = "#FFF";
 		var unit = parseInt(barT) + "°C";
 		if(barT < 60 ){
			color = "#91b1ff";
			curr = document.getElementById("coolingCurrCold");
		}else if(barT >= 60 && barT < 80){
 			color = "#c1d3ff";
 		}else if(barT >= 80 && barT <= 100){
 			color = "#FFF";
 		}else if(barT > 100 && barT <= 120){
 			color = "#ff8c8c";
 		}else if(barT > 120){
 			color = "#ff3131";
 			curr = document.getElementById("coolingCurrHot");
 		}
 		if(isValidCool == 0){
 			unit = " ";
 			curr = document.getElementById("fuelCurrZ");
 		}
 		ctx.drawImage(curr, canvas.width*0.275 +coef, canvas.height*0.56, coolW, coolH);
	    ctx.fillStyle = color;
		ctx.textAlign = 'right'; 
	    ctx.font = "bold italic "+(gearFontNum*0.45).toString()+"px "+fontFam;
	    ctx.shadowColor="black";
		ctx.lineWidth=gearH*0.02;
		ctx.strokeText(unit, canvas.width*0.34 +coef, canvas.height*0.56 + coolH*0.7, gearW, gearH*0.46);
	    ctx.fillText(unit, canvas.width*0.34 +coef, canvas.height*0.56 + coolH*0.7, gearW, gearH*0.46);
	}
    ctx.drawImage(icon, canvas.width*0.29 + 0.67*gaigeW, canvas.height*0.56 + coolH*0.26, coolH*0.7, coolH*0.7); 
	ctx.drawImage(glass, canvas.width*0.29 + 0.15*gaigeW, canvas.height*0.56, coolW, coolH);
	//ctx.drawImage(glassOver, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
}
//gear
function displayGear(input){
	var color;
	var style;
    var gearType;
    var autoGear = ['P','R','N','D','W','S'];
        if(isValidTacho == 0){
            color = '#FFF';
        }else{
        	if(curStyle == 1){
            	color = '#000';
            	style = 'bold ';
        	}
        	else if(curStyle == 2){
            	color = '#FFF';
            	style = 'normal ';
        	}
        }
    var glass = document.getElementById("speedGlass");
	ctx.fillStyle = color;
	ctx.textAlign = 'center'; 
    ctx.font = style+gearFont.toString()+"px "+fontFam;
        if (input === "") {
            gearType = "--";
            ctx.fillText("--", canvas.width*0.60 + gaigeW*0.5 - gearW/33, canvas.height*0.10 + gaigeW*0.496 + gearH*0.3, gearW+gearW*0.7272, gearH*0.46);
            ctx.fillText("--" ,canvas.width*0.60 + gaigeW*0.5 - gearW/33, canvas.height*0.10 + gaigeW*0.496 - gearW/20, gearW+gearW*0.7272, gearH*0.46);
        }else{
            if(isNaN(input)){
                var i;
                var flag = 0;
                gearType = "Auto";		
                for(i=0;i<=6;i++){
                    if(autoGear[i]==input){
                        input = autoGear[i];
                        flag = 1;
                        break;	
                    }
                }
                if(flag!=1){input = "--";gearType = "--";}
            }else{
                gearType = "Manual";

                if(input < 0 || input > 7){
                    input = "--"; gearType = "--";
                }
                if(input == 7){
                    input = "R";	
                }else if(input == 0){
                    input = "N";	
                }
            }
            if(gearType == "--"){
                ctx.font = gearFontNum.toString()+"px "+fontFam;
            }
            else {                
                ctx.font = style+gearFont.toString()+"px "+fontFam;
            }
            ctx.fillText(gearType ,canvas.width*0.60 + gaigeW*0.5 - gearW/33, canvas.height*0.10 + gaigeW*0.496 - gearW/20, gearW+gearW*0.7272, gearH*0.46);
            ctx.font = "italic "+gearFontNum.toString()+"px "+fontFam;
            ctx.fillText(input, canvas.width*0.60 + gaigeW*0.5 - gearW/33, canvas.height*0.10 + gaigeW*0.496 + gearH*0.3, gearW+gearW*0.7272, gearH*0.46);        
        }
   ctx.drawImage(glass, canvas.width*0.60, canvas.height*0.10, gaigeW, gaigeW);
	}
//clock
function displayClock(input){
    var color = "#FFF";
    ctx.fillStyle = color;
	ctx.textAlign = 'center'; 
    ctx.font = "italic "+(gearFontNum*0.55).toString()+"px "+fontFam;
    if (input === "") {
        ctx.fillText("--:--", canvas.width*0.6 + 0.5*gaigeW, canvas.height*0.565, gearW, gearH*0.46);
    }else{
        if(isNaN(input)){
            ctx.fillText("--:--", canvas.width*0.6 + 0.5*gaigeW, canvas.height*0.565, gearW, gearH*0.46);
        }else{
            var minutes = input.getMinutes();
            if(minutes < 10){minutes = "0"+minutes;}
            var clock = input.getHours().toString() + ":" + minutes.toString();           
            ctx.fillText(clock, canvas.width*0.6 + 0.5*gaigeW, canvas.height*0.565, gearW, gearH*0.46);        
        }
    }
}
//fuel level

function filterFuel(targetVal){
	var constSmooth = smoothing / timeConst;
	var filterVal = curFuel + (targetVal - curFuel) / constSmooth;
	curFuel = filterVal;
	return filterVal;
}
function calcFuel(input){
	if(isNaN(input)){
		input=failsafeCoolingTemp;	
		isValidFuel = 0;
	}else{isValidFuel = 1;}
	if(input > 100){input = 50; isValidFuel = 0;}
	if(input < 0){input = 50; isValidFuel = 0;}
	var temp = filterFuel(input);
	return temp;
}
var isValidFuel = 0;
function displayFuel(barT){
	var bg = document.getElementById("fuelBG");
	var bar = document.getElementById("fuelBar");
	var indic = document.getElementById("fuelIn");
    var icon = document.getElementById("fuelIcon");
	var glass = document.getElementById("coolingTempGlass");
	var curr = document.getElementById("fuelCurr");
	var coef = 0;
	var barW = Math.round(coolW*0.468);
	if(curStyle == 2){
		if(barT <= 2){
			indic = document.getElementById("fuelIn");
			curr = document.getElementById("fuelCurrZ");
		}else if(barT > 2 && barT < 98){
			indic = document.getElementById("fuelInZero");
		}else if(barT >= 98){
			indic = document.getElementById("fuelInFull");
		}
		if(isValidFuel == 0){
        	curr = document.getElementById("fuelCurrZ");
		}
	}
	if(barT <= 25){
		icon = document.getElementById("fuelIconError");
	}
	if(isValidFuel == 0){
		bar = document.getElementById("fuelBGError");
		indic = document.getElementById("fuelInError");
        icon = document.getElementById("fuelIconError");
	}
    var color = "#FFF";
    ctx.fillStyle = color;
	ctx.textAlign = 'left'; 
    ctx.font = "italic "+(gearFontNum*0.4).toString()+"px "+fontFam;
    ctx.fillText("E", canvas.width*0.6 + 0.35*gaigeW, canvas.height*0.642, gearW, gearH*0.46);
    ctx.fillText("1/2", canvas.width*0.6 + 0.477*gaigeW, canvas.height*0.642, gearW, gearH*0.46);
    ctx.fillText("F", canvas.width*0.6 + 0.65*gaigeW, canvas.height*0.642, gearW, gearH*0.46);
	ctx.drawImage(bg, canvas.width*0.6 + 0.15*gaigeW, canvas.height*0.62, coolW, coolH);
	ctx.drawImage(bar, canvas.width*0.6 + 0.15*gaigeW, canvas.height*0.62, coolW, coolH);
 
	var bonCoef = Math.round(0.085*coolH);
	coef = (barT/100)*barW;
    if(isValidFuel==0) {coef = 90;}
	ctx.fillStyle = "rgba(255, 255, 255, 0)";
	ctx.fillRect(canvas.width*0.6 + 0.28*gaigeW+0.1231*coolW, canvas.height*0.62+0.0769*coolW,coef,0.5414*coolH);
	ctx.fillStyle = "rgba(0, 0, 0, " + isValidFuel+")";
	ctx.fillRect(canvas.width*0.6 + 0.28*gaigeW + 0.1231*coolW+coef,canvas.height*0.62+0.0739*coolW,barW-coef,0.5214*coolH);

	
	ctx.drawImage(indic, canvas.width*0.6 + 0.15*gaigeW, canvas.height*0.62, coolW, coolH);
    
    if(curStyle == 2){
		ctx.drawImage(curr, canvas.width*0.6 + 0.15*gaigeW +coef,canvas.height*0.62, coolW, coolH);
	}
    
    ctx.drawImage(icon, canvas.width*0.6 + 0.38*gaigeW, canvas.height*0.62 - coolH*0.35, coolH*0.6, coolH*0.6); 
}
//blinkers = turners
//TODO: UNUSED
function activateIcons(){
    if(readLeftTurn == 0){
        readLeftTurn = 1;
    }else if(readLeftTurn == 1){
        readLeftTurn = 0;
    }
    if(readRightTurn == 0){
        readRightTurn = 1;
    }else if(readRightTurn == 1){
        readRightTurn = 0;
    }
   if(readOil == 0){
        readOil = 1;
    }else if(readOil == 1){
        readOil = 0;
    }
    if(readBattery == 0){
        readBattery = 1;
    }else if(readBattery == 1){
        readBattery = 0;
    }
     if(readHazard == 0){
        readHazard = 1;
    }else if(readHazard == 1){
        readHazard = 0;
    }
     if(readBrake == 0){
        readBrake = 1;
    }else if(readBrake == 1){
        readBrake = 0;
    }
    if(readAirbag == 0){
        readAirbag = 1;
    }else if(readAirbag == 1){
        readAirbag = 0;
    }
}

function  displayIcons(){
    displayLeftTurn(readLeftTurn);
    displayRightTurn(readRightTurn);
    displayLights(readLights);
    displayOil(readOil);
    displayBatery(readBattery);
    displayBrake(readBrake);
    displayTriangle(readHazard);
    displayAirbag(readAirbag);
    displayOpenDoors(readOpenDoor);
 }
 
function  displayLeftTurn(input){
    var arrow = document.getElementById("leftTurn");
    var noArrow = document.getElementById("leftTurnEmpty");
    var inactive = document.getElementById("leftTurnInactive");
    var drawTrue = 0;
    var now = new Date().getTime();

    if(input == 0){
     var timeDiff =  (now - lastUpdateTurnRight) / 1000;
        if (timeDiff > sleepConstTurn){
            lastUpdateTurnRight = now;
            if(isBlinkTurnOn == 0){isBlinkTurnOn = 1; }
            else if(isBlinkTurnOn == 1){isBlinkTurnOn = 0;}
        }
        if(isBlinkTurnOn == 0){
            ctx.drawImage(arrow, canvas.width*0.36, canvas.height*0.23, coolW*0.15, coolH*0.8);
        }else{
            ctx.drawImage(noArrow, canvas.width*0.36, canvas.height*0.23, coolW*0.15, coolH*0.8);
        }
   }else{
        ctx.drawImage(inactive, canvas.width*0.36, canvas.height*0.23, coolW*0.15, coolH*0.8);
    }
 }
function  displayRightTurn(input){
    var arrow = document.getElementById("rightTurn");
    var noArrow = document.getElementById("rightTurnEmpty");
    var inactive = document.getElementById("rightTurnInactive");
    var drawTrue = 0;
    var now = new Date().getTime();

    if(input == 0){
     var timeDiff =  (now - lastUpdateTurnRight) / 1000;
        if (timeDiff > sleepConstTurn){
            lastUpdateTurnRight = now;
            if(isBlinkTurnOn == 0){isBlinkTurnOn = 1; }
            else if(isBlinkTurnOn == 1){isBlinkTurnOn = 0;}
        }
        if(isBlinkTurnOn == 0){
            ctx.drawImage(arrow, canvas.width*0.59, canvas.height*0.23, coolW*0.15, coolH*0.8);
        }else{
            ctx.drawImage(noArrow, canvas.width*0.59, canvas.height*0.23, coolW*0.15, coolH*0.8);
        }
   }else{
        ctx.drawImage(inactive, canvas.width*0.59, canvas.height*0.23, coolW*0.15, coolH*0.8);
    }
 }
function  displayLights(input){
    var light = document.getElementById("inactiveLights");
    switch(input) {
        case 0:
            light = document.getElementById("inactiveLights");
            break;
        case 1:
           light = document.getElementById("highBeams");
            break;
        case 2:
            light = document.getElementById("lowBeams");
            break;
        case 3:
            light = document.getElementById("parkingLights");
            break;
      default:
            light = document.getElementById("errorLight");
            break;
    }
    ctx.drawImage(light, canvas.width*0.575, canvas.height*0.31, coolW*0.18, coolH*0.8);
}
function displayOil(input){
    var oil = document.getElementById("oilPressure");
    var inactive = document.getElementById("oilPressureInactive");
    if(input == 0){
        ctx.drawImage(oil, canvas.width*0.05 + gaigeW*0.45, canvas.height*0.59, coolW*0.15, coolH*0.8);
    }else{
        ctx.drawImage(inactive,canvas.width*0.05 + gaigeW*0.45, canvas.height*0.59, coolW*0.15, coolH*0.8);
    }
}
function displayBatery(input){
    var battery = document.getElementById("batteryCharge");
    var inactive = document.getElementById("batteryChargeInactive");
    if(input == 0){
        ctx.drawImage(battery, canvas.width*0.05 + gaigeW*0.45, canvas.height*0.66, coolW*0.15, coolH*0.8);
    }else{
        ctx.drawImage(inactive,canvas.width*0.05 + gaigeW*0.45, canvas.height*0.66, coolW*0.15, coolH*0.8);
    }
}
function displayBrake(input){
    var battery = document.getElementById("brakeWarning");
    var inactive = document.getElementById("brakeWarningInactive");
    if(input == 0){
        ctx.drawImage(battery, canvas.width*0.05 + gaigeW*0.45, canvas.height*0.54, coolW*0.15, coolH*0.8);
    }else{
        ctx.drawImage(inactive,canvas.width*0.05 + gaigeW*0.45, canvas.height*0.54, coolW*0.15, coolH*0.8);
    }
}
function displayTriangle(input){
    var hazardLight = document.getElementById("hazardLights");
    var inactive = document.getElementById("hazardLightsInactive");
    if(input == 0){
        ctx.drawImage(hazardLight, canvas.width*0.495 + gaigeW*0.115, canvas.height*0.24, coolW*0.2, coolH*0.8);
    }else{
        ctx.drawImage(inactive,canvas.width*0.495 + gaigeW*0.115, canvas.height*0.24, coolW*0.2, coolH*0.8);
    }
}
function displayAirbag(input){
    var airbag = document.getElementById("airbag");
    var inactive = document.getElementById("airbagInactive");
    if(input == 0){
        ctx.drawImage(airbag, canvas.width*0.495 + gaigeW*0.125, canvas.height*0.31, coolW*0.18, coolH*0.8);
    }else{
        ctx.drawImage(inactive,canvas.width*0.495 + gaigeW*0.125, canvas.height*0.31, coolW*0.18, coolH*0.8);
    }
}

function displayOpenDoors(input){
    var inactive = document.getElementById("openDoorInactive");
    if(isNaN(input)){ input = 0;}
    if(input > 0 && input <= 11){
        var door = document.getElementById("openDoor" + input);
        ctx.drawImage(door, canvas.width*0.495 + gaigeW*0.085, canvas.height*0.415, coolW*0.35, coolW*0.35);
    }else{
        ctx.drawImage(inactive,canvas.width*0.495 + gaigeW*0.085, canvas.height*0.415, coolW*0.35, coolW*0.35);
    }
}
//test & misc
function rand(min,max){
	return Math.random() * (max ?(max-min) : min) + (max ? min : 0)
	 }
function sleep(milliseconds) {
  var start = new Date().getTime();
  for (var i = 0; i < 1e7; i++) {
    if ((new Date().getTime() - start) > milliseconds){
      break;
    }
  }
}
function elapsedTime(){
	var now = new Date().getTime();
	var elapsedTime = now - lastUpdate;
	if (elapsedTime > sleepConst){
		lastUpdate = now;
		return 1;	
	}
	else {
		return 0;
	}
}

function elapsedTimeTacho(){
	var now = new Date().getTime();
	var elapsedTime = now - lastUpdateTacho;
	if (elapsedTime > sleepConst){
		lastUpdateTacho = now;
		return 1;	
	}
	else {
		return 0;
	}
}
function stressTest(){
	var x = document.getElementsByClassName('inputVal');
	var body = document.getElementsByTagName('body')[0];
	var text = document.getElementById('butTestText');
	var i = 0;
	if(testPrompt == 1){
		for(i=0;i<x.length;i++){
			x[i].style.display = "none";
			body.style.background="#000";
			text.style.color = "#FFF";
		}
		testPrompt = 0;
	}else if(testPrompt == 0){
		for(i=0;i<x.length;i++){
			x[i].style.display = "inline";
			body.style.background="#FFF";
			text.style.color = "#000";
		}
		show = 0;
		testPrompt = 1;
	}
	lastTest = testPrompt;
}
function hideAll(){
	var x = document.getElementById("buttonVal");
	var h = document.getElementById("hideButton");
	var body = document.getElementsByTagName('body')[0];
	if(hidePrompt == 0){
		x.style.display = "none"
		hidePrompt = 1;
		h.innerHTML = "-";
		h.style.background="#000";
		h.style.color="#FFF";
		h.style.border="0px solid #FFF";
		body.style.background="#000";
	}else if(hidePrompt == 1){
		x.style.display = "inline";
		hidePrompt = 0;
		h.innerHTML = "Hide all";
		body.style.background="#FFF";
		h.style.background="#f1f1f1";
		h.style.color="#000";
		h.style.border="2px solid #000";
	}
}
function elapsedTimeTest(){
	var now = new Date().getTime();
	var elapsedTime = now - lastUpdateTest;
	if (elapsedTime > 100){
		lastUpdateTest = now;
		return 1;	
	}
	else {
		return 0;
	}
}

function styleChange(){
	var styleNum = 0;
	if(curStyle == 1){
		speedArrow.src = "style2/skorostomer/skorostomermidarrow.png";
		tachArrow.src = "style2/skorostomer/skorostomermidarrow.png";
		styleNum = 2;
		fontFam = 'Courier';
	}else if(curStyle == 2){
		speedArrow.src = "style1/skorostomer/skorostomermidarrow.png";
		tachArrow.src = "style1/skorostomer/skorostomermidarrow.png";
		styleNum = 1;
		fontFam = 'Verdana';
	}else{
        //default to Style 1
        speedArrow.src = "style1/skorostomer/skorostomermidarrow.png";
        tachArrow.src = "style1/skorostomer/skorostomermidarrow.png";
        styleNum = 1;
        fontFam = 'Verdana';
    }
	
	var carImgDivs = document.getElementsByClassName('element');
	for(var i = 0; i < carImgDivs.length; i++){
		var newStyle = "style"+styleNum;
    	var replacedSrc = carImgDivs[i].getAttribute('src');
    	replacedSrc = replacedSrc.replace( /style\d/,newStyle);
    	carImgDivs[i].setAttribute("src", replacedSrc);
	}
	curStyle = styleNum;
}


//евентуално: почисти малко кода
</script>

</html>
